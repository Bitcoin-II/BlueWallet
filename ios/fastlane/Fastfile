default_platform(:ios)

platform :ios do
  desc "Deploy to TestFlight"
  lane :deploy do
    # Ensure git status is clean
    ensure_git_status_clean

    # Increment the build number
    increment_build_number(xcodeproj: "BlueWallet.xcodeproj") # Update path as needed

    # Install pods
    cocoapods(repo_update: true)

    # Synchronize certificates and provisioning profiles for each scheme
    synchronize_profiles(schemes: {
      "BlueWallet" => "io.bluewallet.bluewallet",
      "BlueWalletWatch" => "io.bluewallet.bluewallet.watch",
      "BlueWalletWatch Extension" => "io.bluewallet.bluewallet.watch.extension",
      "Stickers" => "io.bluewallet.bluewallet.Stickers",
      "WidgetsExtension" => "io.bluewallet.bluewallet.MarketWidget"
    })

    # Build the main app
    build_app(
      scheme: "BlueWallet",
      workspace: "BlueWallet.xcworkspace",
      export_method: "app-store"
    )

    # Upload to TestFlight
    upload_to_testflight(skip_waiting_for_build_processing: false)

    # Clean up build artifacts
    clean_build_artifacts

    # Versioning and Git operations
    # ...
  end

  private_lane :synchronize_profiles do |options|
    options[:schemes].each do |scheme, identifier|
      match(type: "appstore", app_identifier: identifier)
    end
  end
end