default_platform(:ios)

platform :ios do
  desc "Deploy to TestFlight"
  lane :deploy do
    # Ensure git status is clean
   
   # ensure_git_status_clean

    # Increment the build number
    increment_build_number(xcodeproj: "BlueWallet.xcodeproj") # Update path as needed

    # Install pods
    cocoapods(repo_update: true)

    match(
      type: "appstore",
      app_identifier: [
        "io.bluewallet.bluewallet",                # Main App
        "io.bluewallet.bluewallet.watch",          # Watch App
        "io.bluewallet.bluewallet.watch.extension",# Watch Extension
        "io.bluewallet.bluewallet.Stickers",       # Stickers Extension
        "io.bluewallet.bluewallet.MarketWidget",         # Widget Extension
      ],
      team_id: "A7W54YZ4WU", # Your Apple Developer Account Team ID
      team_name: "Apple Distribution: Bluewallet Services, S. R. L." # Optional: Your Apple Developer Account Team Name
    )

    # Synchronize certificates and provisioning profiles for each scheme
    synchronize_profiles(schemes: {
      "BlueWallet" => "io.bluewallet.bluewallet",
      "BlueWalletWatch" => "io.bluewallet.bluewallet.watch",
      "BlueWalletWatch Extension" => "io.bluewallet.bluewallet.watch.extension",
      "Stickers" => "io.bluewallet.bluewallet.Stickers",
      "WidgetsExtension" => "io.bluewallet.bluewallet.MarketWidget"
    })

    # Build the main app
    build_app(
      scheme: "BlueWallet",
      workspace: "BlueWallet.xcworkspace",
      export_method: "app-store",
      export_team_id: "A7W54YZ4WU"
    )

    # Upload to TestFlight
    upload_to_testflight(skip_waiting_for_build_processing: false)

    # Clean up build artifacts
    clean_build_artifacts

    # Versioning and Git operations
    # ...
  end

  private_lane :synchronize_profiles do |options|
    options[:schemes].each do |scheme, identifier|
      match(type: "appstore", app_identifier: identifier, team_id: "A7W54YZ4WU") # Specify the team ID here
    end
  end
end